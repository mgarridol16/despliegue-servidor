# =====================================================================
# ADVERTENCIA PARA EL DESPLIEGUE:
# Este archivo est√° configurado para producci√≥n con SSL (DuckDNS).
# Si clonas este repositorio y NO tienes certificados en tu m√°quina,
# DEBES COMENTAR las l√≠neas 'listen 443' y 'ssl_certificate' para 
# que Nginx pueda arrancar en el puerto 80.
# 1. Si NO tienes certificados: 
#    - Mant√©n COMENTADO el 'return 301' del primer bloque.
#    - Mant√©n COMENTADO el bloque 'listen 443' y las rutas 'ssl_certificate'.
#
# 2. Si TIENES certificados listos:
#    - Descomenta las l√≠neas del puerto 443 y SSL.
#    - Descomenta el 'return 301' para forzar HTTPS.
# =====================================================================

# BLOQUE 1: Redirecci√≥n HTTP a HTTPS
server {
    listen 80;
    server_name miguel.2daw grafana.miguel.2daw portainer.miguel.2daw miguel-daw-practica.duckdns.org 192.168.1.13; 
    return 301 https://$host$request_uri;
}

# BLOQUE 2: Dominio principal (Grafana y App)
server {
    listen 443 ssl;
    # IMPORTANTE: Aqu√≠ he QUITADO portainer.miguel.2daw
    server_name miguel.2daw grafana.miguel.2daw miguel-daw-practica.duckdns.org 192.168.1.13; 

    ssl_certificate /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/privkey.pem;

    # Acceso a Grafana
    location / {
        proxy_pass http://grafana:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Acceso a App Profesor
    location /app-profesor/ {
        proxy_pass http://app-profesor:80/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# BLOQUE 3: Espec√≠fico para PORTAINER
server {
    listen 443 ssl;
    server_name portainer.miguel.2daw; # Ahora este nombre solo existe AQU√ç

    ssl_certificate /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/privkey.pem;

    location / {
        proxy_pass http://portainer:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =============================================================================
# üìò RUNBOOK DE CONFIGURACI√ìN - NGINX PROXY (MIGUEL DAW)
# =============================================================================
# 
# Para que funcione en tu m√°quina, sigue estas instrucciones:
#
# 1. MODO B√ÅSICO (HTTP/IP): Descomenta el bloque 'listen 80' y sus 'locations'.
# 2. MODO SEGURO (HTTPS): Requiere certificados SSL v√°lidos en las rutas indicadas.
# 3. IP: Recuerda cambiar '192.168.0.25' por la IP actual de tu m√°quina.
# =============================================================================

# --- BLOQUE HTTP (PUERTO 80) ---
# server {
#     listen 80;
#     server_name miguel-daw-practica.duckdns.org 192.168.0.25;
#
#     # REDIRECCI√ìN A HTTPS: Solo descomentar si tienes el certificado listo.
#     # return 301 https://$host$request_uri;
#
#     # ACCESO A GRAFANA
#     # location / {
#     #     proxy_pass http://grafana:3000;
#     #     proxy_set_header Host $host;
#     # }
#
#     # ACCESO A PORTAINER
#     # location /portainer/ {
#     #     proxy_pass http://portainer:9000/;
#     #     proxy_set_header Host $host;
#     # }
#
#     # ACCESO A APP-PROFESOR (Requiere que el contenedor est√© en 'red-proxy')
#     # location /app-profesor/ {
#     #     proxy_pass http://app-profesor:80/;
#     #     proxy_set_header Host $host;
#     # }
# }

# --- BLOQUE HTTPS (PUERTO 443) ---
# server {
#     listen 443 ssl;
#     server_name miguel-daw-practica.duckdns.org 192.168.0.25;
#
#     # RUTAS DE CERTIFICADOS (SSL)
#     # ssl_certificate /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/fullchain.pem;
#     # ssl_certificate_key /etc/letsencrypt/live/miguel-daw-practica.duckdns.org/privkey.pem;
#
#     # Para usar SSL, copia aqu√≠ dentro los mismos 'location' del bloque anterior.
# }
